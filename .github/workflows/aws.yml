on:
  release:
    types: [created]

name: Deploy to Cloudformation

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Deploy Cloudformation
      env:
        AWS_PROFILE: default
        AWS_REGION: ${{ secrets.AWS_REGION }}
        ROLE_ARN: ${{ secrets.ROLE_ARN }}
        BUCKET: ${{ secrets.BUCKET }}
        AWS_KEY_NAME: ${{ secrets.AWS_KEY_NAME }}
        PrivoxyPort: ${{ secrets.PRIVOXY_PORT }}
      run: |
        export NbAzs=$(sh ./bin/getRegionAzs.sh $AWS_PROFILE $AWS_REGION)
        export AWS_SOURCE_AMI=$(sh ./bin/detect-ami.sh $AWS_PROFILE $AWS_REGION)
        make deploy
        make describe
